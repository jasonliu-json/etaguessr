<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Point Selector</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: row;
            margin: 0;
            overflow: hidden;
        }

        #info {
            width: 350px;
            min-width: 250px;
            max-width: 600px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #resize-handle {
            width: 5px;
            background: transparent;
            cursor: col-resize;
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 1000;
        }

        #resize-handle:hover {
            background: #1a73e8;
        }

        #resize-handle:active {
            background: #1557b0;
        }

        #map {
            flex: 1;
            height: 100vh;
        }

        #info h2 {
            margin-bottom: 10px;
            color: #333;
            font-size: 18px;
        }

        #coordinates {
            font-family: 'Courier New', monospace;
            background: #f5f5f5;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            color: #555;
        }

        .coord-row {
            margin: 5px 0;
        }

        .label {
            font-weight: bold;
            color: #1a73e8;
        }

        #instructions {
            margin-top: 10px;
            padding: 10px;
            background: #e8f0fe;
            border-radius: 6px;
            color: #1967d2;
            font-size: 14px;
        }

        #eta-section {
            margin-top: 15px;
            padding: 15px;
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
        }

        #eta-section h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }

        .eta-row {
            margin: 8px 0;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mode-name {
            font-weight: 600;
            color: #555;
        }

        .mode-time {
            color: #1a73e8;
            font-weight: bold;
        }

        .compass {
            font-size: 24px;
            margin-left: 10px;
            display: inline-block;
            transition: transform 0.3s ease;
        }

        #city-selector {
            margin-top: 10px;
            margin-bottom: 5px;
        }

        #city-selector label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }

        #city-selector select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            font-family: inherit;
        }

        #city-selector select:hover {
            border-color: #1a73e8;
        }

        #city-selector select:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        button {
            margin-top: 10px;
            padding: 12px 24px;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
        }

        button:hover {
            background: #1557b0;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #submitBtn {
            background: #34a853;
            margin-top: 15px;
        }

        #submitBtn:hover {
            background: #2d8e47;
        }

        #revealDirectionBtn {
            background: #f59e0b;
            margin-top: 15px;
        }

        #revealDirectionBtn:hover {
            background: #d97706;
        }

        #result {
            margin-top: 15px;
            padding: 15px;
            background: #f0f7ff;
            border: 2px solid #1a73e8;
            border-radius: 6px;
            display: none;
        }

        #result h3 {
            margin-bottom: 10px;
            color: #1a73e8;
            font-size: 16px;
        }

        .result-row {
            margin: 5px 0;
            font-size: 14px;
        }

        .result-label {
            font-weight: bold;
            color: #555;
        }

        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }

        #newGameBtn {
            background: #ea4335;
            display: none;
        }

        #newGameBtn:hover {
            background: #c5221f;
        }

        #compass-indicator {
            margin-top: 15px;
            padding: 15px;
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            text-align: center;
            display: none;
        }

        #compass-indicator h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }

        .compass-display {
            font-size: 48px;
            margin: 10px 0;
        }

        #score-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px 60px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #score-popup.show {
            opacity: 1;
        }

        .score-value {
            font-size: 72px;
            font-weight: bold;
            color: #1a73e8;
            margin: 0;
        }

        .score-label {
            font-size: 24px;
            color: #666;
            margin-top: 10px;
        }

        /* Mobile toggle button */
        #mobile-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1001;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: transform 0.2s;
        }

        #mobile-toggle:active {
            transform: scale(0.95);
        }

        /* Mobile responsive styles */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            #info {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                max-width: 100%;
                min-width: 100%;
                height: 60vh;
                max-height: 80vh;
                z-index: 1000;
                box-shadow: 0 -4px 12px rgba(0,0,0,0.2);
                transform: translateY(calc(100% - 60px));
                transition: transform 0.3s ease;
                border-radius: 16px 16px 0 0;
            }

            #info.mobile-open {
                transform: translateY(0);
            }

            #info::before {
                content: '';
                display: block;
                width: 40px;
                height: 4px;
                background: #ccc;
                border-radius: 2px;
                position: absolute;
                top: 8px;
                left: 50%;
                transform: translateX(-50%);
            }

            #resize-handle {
                display: none;
            }

            #map {
                flex: 1;
                width: 100%;
                height: 100vh;
            }

            #mobile-toggle {
                display: block;
            }

            #mobile-toggle.hidden {
                display: none;
            }

            /* Larger touch targets */
            button {
                padding: 14px 28px;
                font-size: 16px;
                min-height: 44px;
            }

            #city-selector select {
                padding: 12px;
                font-size: 16px;
                min-height: 44px;
            }

            /* Better spacing on mobile */
            #info {
                padding: 24px 16px 16px;
            }

            h2 {
                font-size: 20px;
                margin-bottom: 12px;
            }

            h3 {
                font-size: 16px;
            }

            .eta-row {
                padding: 10px;
            }

            /* Score popup adjustments */
            #score-popup {
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) scale(0);
            }

            #score-popup.show {
                transform: translate(-50%, -50%) scale(1);
            }
        }

        /* Tablet landscape */
        @media (min-width: 769px) and (max-width: 1024px) {
            #info {
                width: 380px;
                min-width: 280px;
            }
        }
    </style>
</head>
<body>
    <div id="info">
        <div id="resize-handle"></div>
        <h2 id="game-title">ETA Guesser</h2>

        <div id="city-selector">
            <label for="city-select">Select City:</label>
            <select id="city-select" onchange="onCityChange()">
                <option value="toronto">Toronto</option>
                <option value="san-francisco">San Francisco</option>
                <option value="calgary">Calgary</option>
                <option value="vancouver">Vancouver</option>
                <option value="new-york">New York</option>
                <option value="boston">Boston</option>
            </select>
        </div>

        <button id="randomBtn" onclick="getRandomDestination()">New Game</button>
        <button id="newGameBtn" onclick="startNewGame()">New Game</button>

        <div id="coordinates">
            <div class="coord-row"><span class="label">Origin:</span> <span id="origin">???</span></div>
            <div class="coord-row"><span class="label">Destination:</span> <span id="destination">???</span></div>
        </div>

        <button id="revealDirectionBtn" onclick="revealDirection()" style="display: none;">üß≠ Reveal Direction Hint</button>

        <div id="compass-indicator" style="display: none;">
            <h3>Direction to Destination</h3>
            <div class="compass-display" id="compass-arrow"></div>
        </div>

        <div id="eta-section" style="display: none;">
            <h3>Current Travel Times</h3>
            <div id="eta-content"></div>
        </div>

        <button id="submitBtn" onclick="submitGuess()" style="display: none;">Submit My Guess</button>

        <div id="result">
            <h3>Results</h3>
            <div id="result-content"></div>
        </div>

        <div id="instructions">
            Good luck!
        </div>
    </div>

    <div id="map"></div>

    <button id="mobile-toggle" onclick="toggleMobilePanel()">‚ò∞</button>

    <div id="score-popup">
        <p class="score-value" id="score-value">0</p>
        <p class="score-label">points</p>
    </div>

    <script>
        let map;
        let destinationMarker;
        let guessMarker;
        let origin1Marker;
        let origin2Marker;
        let distanceLine = null;
        let actualOrigin1 = null;
        let actualOrigin2 = null;
        let actualDestination = null;
        let gameActive = false;
        let mapClickListener = null;
        let trafficLayer;
        let transitLayer;

        // Mobile panel state
        function toggleMobilePanel() {
            const infoPanel = document.getElementById('info');
            const toggleBtn = document.getElementById('mobile-toggle');

            infoPanel.classList.toggle('mobile-open');

            // Change button icon
            if (infoPanel.classList.contains('mobile-open')) {
                toggleBtn.textContent = '√ó';
            } else {
                toggleBtn.textContent = '‚ò∞';
            }
        }

        // City configurations
        let selectedCity = 'toronto';
        let cityConfigs = {
            'toronto': {
                name: 'Toronto',
                center: { lat: 43.6452, lng: -79.3806 },
                centerName: 'Union Station',
                radiusKm: 10,
                zoom: 12
            },
            'san-francisco': {
                name: 'San Francisco',
                center: { lat: 37.7749, lng: -122.4194 },
                centerName: 'Downtown',
                radiusKm: 10,
                zoom: 12
            },
            'calgary': {
                name: 'Calgary',
                center: { lat: 51.0447, lng: -114.0719 },
                centerName: 'Downtown',
                radiusKm: 10,
                zoom: 12
            },
            'vancouver': {
                name: 'Vancouver',
                center: { lat: 49.2827, lng: -123.1207 },
                centerName: 'Downtown',
                radiusKm: 10,
                zoom: 12
            },
            'new-york': {
                name: 'New York',
                center: { lat: 40.7580, lng: -73.9855 },
                centerName: 'Times Square',
                radiusKm: 10,
                zoom: 12
            },
            'boston': {
                name: 'Boston',
                center: { lat: 42.3601, lng: -71.0589 },
                centerName: 'Downtown',
                radiusKm: 10,
                zoom: 12
            }
        };

        // URL path to city mapping
        const pathToCityMap = {
            // Heroku paths
            '/san-francisco': 'san-francisco',
            '/sf': 'san-francisco',
            '/toronto': 'toronto',
            '/calgary': 'calgary',
            '/vancouver': 'vancouver',
            '/new-york': 'new-york',
            '/nyc': 'new-york',
            '/boston': 'boston',
            '/': 'toronto',
            // GitHub Pages paths (with repo name)
            '/etaguessr/': 'toronto',
            '/etaguessr': 'toronto',
            '/etaguessr/toronto': 'toronto',
            '/etaguessr/san-francisco': 'san-francisco',
            '/etaguessr/sf': 'san-francisco',
            '/etaguessr/calgary': 'calgary',
            '/etaguessr/vancouver': 'vancouver',
            '/etaguessr/new-york': 'new-york',
            '/etaguessr/nyc': 'new-york',
            '/etaguessr/boston': 'boston'
        };

        // Get base path (for GitHub Pages compatibility)
        function getBasePath() {
            const path = window.location.pathname;
            // Check if we're on GitHub Pages (path includes repo name)
            if (path.startsWith('/etaguessr')) {
                return '/etaguessr';
            }
            return '';
        }

        // Initialize city from URL path
        function initializeCityFromURL() {
            // Check for GitHub Pages 404 redirect
            const redirect = sessionStorage.getItem('redirect');
            if (redirect) {
                console.log('[City Init] Detected 404 redirect, restoring path:', redirect);
                sessionStorage.removeItem('redirect');
                // Restore the path without reloading
                window.history.replaceState(null, '', redirect);
            }

            const path = window.location.pathname;
            const cityFromPath = pathToCityMap[path];

            console.log('[City Init] Current path:', path);
            console.log('[City Init] Mapped to city:', cityFromPath);

            if (cityFromPath && cityConfigs[cityFromPath]) {
                selectedCity = cityFromPath;
                console.log('[City Init] Selected city:', selectedCity, cityConfigs[cityFromPath].name);
                const citySelect = document.getElementById('city-select');
                if (citySelect) {
                    citySelect.value = selectedCity;
                }
            } else {
                console.log('[City Init] No city mapping found for path, using default:', selectedCity);
            }
        }

        // Get current city config
        function getCurrentCityConfig() {
            return cityConfigs[selectedCity];
        }

        // Handle city change
        function onCityChange() {
            const citySelect = document.getElementById('city-select');
            selectedCity = citySelect.value;

            // Update URL without reloading page
            const basePath = getBasePath();
            const newPath = selectedCity === 'toronto'
                ? (basePath || '/')
                : `${basePath}/${selectedCity}`;
            window.history.pushState({city: selectedCity}, '', newPath);

            // Update title
            const cityConfig = getCurrentCityConfig();
            document.getElementById('game-title').textContent = `ETA Guesser - ${cityConfig.name}`;

            // Re-center map
            if (map) {
                map.setCenter(cityConfig.center);
                map.setZoom(cityConfig.zoom);
            }

            // Reset game if one is active
            if (gameActive) {
                getRandomDestination();
            }
        }

        // Handle browser back/forward buttons
        window.addEventListener('popstate', function(event) {
            initializeCityFromURL();

            // Update dropdown
            const citySelect = document.getElementById('city-select');
            if (citySelect) {
                citySelect.value = selectedCity;
            }

            // Update title and map
            const cityConfig = getCurrentCityConfig();
            document.getElementById('game-title').textContent = `ETA Guesser - ${cityConfig.name}`;

            if (map) {
                map.setCenter(cityConfig.center);
                map.setZoom(cityConfig.zoom);
            }

            // Reset game if one is active
            if (gameActive) {
                getRandomDestination();
            }
        });

        // For backwards compatibility
        const UNION_STATION = { lat: 43.6452, lng: -79.3806 };

        // Panel resize functionality
        (function() {
            const resizeHandle = document.getElementById('resize-handle');
            const infoPanel = document.getElementById('info');
            let isResizing = false;

            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;

                const newWidth = e.clientX;
                const minWidth = 250;
                const maxWidth = 600;

                if (newWidth >= minWidth && newWidth <= maxWidth) {
                    infoPanel.style.width = newWidth + 'px';
                    // Trigger map resize
                    if (map && google.maps.event) {
                        google.maps.event.trigger(map, 'resize');
                    }
                }
            });

            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        })();

        function calculateBearing(lat1, lng1, lat2, lng2) {
            // Calculate bearing/direction from point 1 to point 2
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const lat1Rad = lat1 * Math.PI / 180;
            const lat2Rad = lat2 * Math.PI / 180;

            const y = Math.sin(dLng) * Math.cos(lat2Rad);
            const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) -
                      Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLng);

            const bearing = Math.atan2(y, x) * 180 / Math.PI;
            return (bearing + 360) % 360; // Normalize to 0-360
        }

        function getCompassArrow(bearing) {
            // Rotate arrow based on bearing (0¬∞ = North, 90¬∞ = East, etc.)
            return `<span class="compass" style="transform: rotate(${bearing}deg);">‚Üë</span>`;
        }

        function calculateScore(distanceKm) {
            // Geoguessr-style scoring: max 5000 points
            // Score decreases exponentially with distance
            // Perfect guess (0km) = 5000 points
            // ~1km = ~4500 points
            // ~5km = ~3000 points
            // ~10km = ~1500 points
            // ~25km = ~100 points

            
            const maxScore = 5000;
            const decayFactor = 0.25; 
            const score = Math.round(maxScore * Math.exp(-decayFactor * Math.max(0, distanceKm-0.05)));
            return Math.max(0, Math.min(maxScore, score));
        }

        function showScoreAnimation(score) {
            const popup = document.getElementById('score-popup');
            const scoreValue = document.getElementById('score-value');

            scoreValue.textContent = score;
            popup.classList.add('show');

            setTimeout(() => {
                popup.classList.remove('show');
            }, 1000);
        }

        function startNewGame() {
            // Hide new game button, will show submit after placing guess
            document.getElementById('newGameBtn').style.display = 'none';
            document.getElementById('randomBtn').style.display = 'block';

            // Start new game
            getRandomDestination();
        }

        function revealDirection() {
            // Show the compass indicator
            const compassIndicator = document.getElementById('compass-indicator');
            const revealDirectionBtn = document.getElementById('revealDirectionBtn');

            compassIndicator.style.display = 'block';
            revealDirectionBtn.style.display = 'none';
        }

        function initMap() {
            // Initialize city from URL first
            initializeCityFromURL();

            // Get current city config
            const cityConfig = getCurrentCityConfig();

            // Create map centered on selected city
            map = new google.maps.Map(document.getElementById('map'), {
                center: cityConfig.center,
                zoom: cityConfig.zoom,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: true
            });

            // Add traffic layer
            trafficLayer = new google.maps.TrafficLayer();
            trafficLayer.setMap(map);

            // Add transit layer
            transitLayer = new google.maps.TransitLayer();
            transitLayer.setMap(map);

            // Update title
            document.getElementById('game-title').textContent = `ETA Guesser - ${cityConfig.name}`;

            // Auto-pick destination on load
            getRandomDestination();
        }

        function enableMapGuessing() {
            // Remove previous listener if exists
            if (mapClickListener) {
                google.maps.event.removeListener(mapClickListener);
            }

            // Add click listener for guessing
            mapClickListener = map.addListener('click', (event) => {
                if (!gameActive) return;

                placeGuessMarker(event.latLng);
            });
        }

        function placeGuessMarker(location) {
            // Remove existing guess marker if any
            if (guessMarker) {
                guessMarker.setMap(null);
            }

            // Create new guess marker
            guessMarker = new google.maps.Marker({
                position: location,
                map: map,
                title: 'Your Guess',
                label: '?',
                animation: google.maps.Animation.DROP,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: '#FFA500',
                    fillOpacity: 0.8,
                    strokeColor: '#FF8C00',
                    strokeWeight: 2
                }
            });

            // Show submit button
            document.getElementById('submitBtn').style.display = 'block';
        }

        async function getRandomDestination() {
            const button = document.getElementById('randomBtn');
            const newGameBtn = document.getElementById('newGameBtn');
            const etaSection = document.getElementById('eta-section');
            const etaContent = document.getElementById('eta-content');
            const destinationText = document.getElementById('destination');
            const submitBtn = document.getElementById('submitBtn');
            const resultDiv = document.getElementById('result');
            const instructionsDiv = document.getElementById('instructions');
            const compassIndicator = document.getElementById('compass-indicator');
            const revealDirectionBtn = document.getElementById('revealDirectionBtn');

            // Reset game state and clear all old markers/lines
            gameActive = false;
            actualOrigin1 = null;
            actualOrigin2 = null;
            actualDestination = null;
            if (origin1Marker) {
                origin1Marker.setMap(null);
                origin1Marker = null;
            }
            if (origin2Marker) {
                origin2Marker.setMap(null);
                origin2Marker = null;
            }
            if (destinationMarker) {
                destinationMarker.setMap(null);
                destinationMarker = null;
            }
            if (guessMarker) {
                guessMarker.setMap(null);
                guessMarker = null;
            }
            if (distanceLine) {
                distanceLine.setMap(null);
                distanceLine = null;
            }
            submitBtn.style.display = 'none';
            newGameBtn.style.display = 'none';
            resultDiv.style.display = 'none';
            compassIndicator.style.display = 'none';
            revealDirectionBtn.style.display = 'none';

            // Disable button and show loading
            button.disabled = true;
            button.textContent = 'Loading...';
            const originText = document.getElementById('origin');
            originText.textContent = 'Picking random starting locations...';
            destinationText.textContent = 'Picking random destination...';
            etaContent.innerHTML = '<div class="loading">Calculating ETAs...</div>';
            etaSection.style.display = 'block';

            try {
                // Call backend (deployed on Heroku) with selected city
                const response = await fetch(`https://toronto-etaguessr-api-cdf6cdc7db27.herokuapp.com/random-destination?city=${selectedCity}`);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // Store origins and destination
                actualOrigin1 = {
                    lat: data.origin1.lat,
                    lng: data.origin1.lng,
                    address: data.origin1_address
                };

                actualOrigin2 = {
                    lat: data.origin2.lat,
                    lng: data.origin2.lng,
                    address: data.origin2_address
                };

                actualDestination = {
                    lat: data.destination.lat,
                    lng: data.destination.lng,
                    address: data.destination_address,
                    etas1: data.etas1,
                    etas2: data.etas2
                };

                // Create origin markers
                origin1Marker = new google.maps.Marker({
                    position: actualOrigin1,
                    map: map,
                    title: 'Starting Location 1',
                    label: 'A',
                    animation: google.maps.Animation.DROP
                });

                origin2Marker = new google.maps.Marker({
                    position: actualOrigin2,
                    map: map,
                    title: 'Starting Location 2',
                    label: 'B',
                    animation: google.maps.Animation.DROP
                });

                // Update origin and destination display
                originText.innerHTML = `<strong>A:</strong> ${actualOrigin1.address}<br><strong>B:</strong> ${actualOrigin2.address}`;
                destinationText.textContent = '??? (Click on map to guess!)';

                // Display ETAs in table format (without walking)
                displayETAsTable(data.etas1, data.etas2);

                // Enable game mode
                gameActive = true;
                enableMapGuessing();

                // Show reveal direction button
                revealDirectionBtn.style.display = 'block';

                // Update instructions
                instructionsDiv.innerHTML = 'Based on the travel times from <strong>TWO</strong> starting locations (A and B) to the destination, click on the map to guess where the destination is!';
                instructionsDiv.style.background = '#fff3cd';
                instructionsDiv.style.color = '#856404';

                // Adjust map view to show both origins
                const bounds = new google.maps.LatLngBounds();
                bounds.extend(actualOrigin1);
                bounds.extend(actualOrigin2);
                map.fitBounds(bounds);
                map.setZoom(Math.min(map.getZoom(), 13));

            } catch (error) {
                console.error('Error:', error);
                destinationText.textContent = 'Error getting destination';
                etaContent.innerHTML = '<div class="loading">Error: ' + error.message + '</div>';
            } finally {
                button.disabled = false;
                button.textContent = 'New Game';
            }
        }

        function displayETAs(etas) {
            if (!actualDestination) return;

            const etaContent = document.getElementById('eta-content');
            const compassIndicator = document.getElementById('compass-indicator');
            const compassArrow = document.getElementById('compass-arrow');

            const modes = [
                { key: 'driving', name: 'üöó Driving', icon: 'üöó' },
                { key: 'transit', name: 'üöá Public Transit', icon: 'üöá' },
                { key: 'bicycling', name: 'üö¥ Cycling', icon: 'üö¥' },
                { key: 'walking', name: 'üö∂ Walking', icon: 'üö∂' }
            ];

            // Calculate bearing to destination (but don't show compass yet)
            const bearing = calculateBearing(
                actualOrigin.lat, actualOrigin.lng,
                actualDestination.lat, actualDestination.lng
            );
            compassArrow.innerHTML = getCompassArrow(bearing);
            // Compass will be shown when user clicks "Reveal Direction Hint" button

            // Display ETAs without compass arrows
            let html = '';
            modes.forEach(mode => {
                const eta = etas[mode.key];
                if (eta && !eta.error) {
                    html += `
                        <div class="eta-row">
                            <span class="mode-name">${mode.name}</span>
                            <span class="mode-time">${eta.duration}</span>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="eta-row">
                            <span class="mode-name">${mode.name}</span>
                            <span class="mode-time" style="color: #999;">N/A</span>
                        </div>
                    `;
                }
            });

            etaContent.innerHTML = html;
        }

        function displayETAsTable(etas1, etas2) {
            if (!actualDestination) return;

            const etaContent = document.getElementById('eta-content');

            // Modes to display (excluding walking)
            const modes = [
                { key: 'driving', name: 'üöó Driving', icon: 'üöó' },
                { key: 'transit', name: 'üöá Transit', icon: 'üöá' },
                { key: 'bicycling', name: 'üö¥ Cycling', icon: 'üö¥' }
            ];

            // Build table HTML
            let html = `
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr style="border-bottom: 2px solid #ddd;">
                            <th style="text-align: left; padding: 8px; font-weight: bold;">Mode</th>
                            <th style="text-align: center; padding: 8px; font-weight: bold;">From A</th>
                            <th style="text-align: center; padding: 8px; font-weight: bold;">From B</th>
                            <th style="text-align: center; padding: 8px; font-weight: bold;">To Dest</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            modes.forEach(mode => {
                const eta1 = etas1[mode.key];
                const eta2 = etas2[mode.key];

                const time1 = eta1 && !eta1.error ? eta1.duration : 'N/A';
                const time2 = eta2 && !eta2.error ? eta2.duration : 'N/A';

                html += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px; font-weight: 500;">${mode.name} ${mode.name.replace(/üöó|üöá|üö¥/, '')}</td>
                        <td style="text-align: center; padding: 10px; color: #1a73e8; font-weight: 600;">${time1}</td>
                        <td style="text-align: center; padding: 10px; color: #1a73e8; font-weight: 600;">${time2}</td>
                        <td style="text-align: center; padding: 10px; color: #666; font-style: italic;">???</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            etaContent.innerHTML = html;
        }

        function displayETAsTableWithDestination(etas1, etas2) {
            if (!actualDestination) return;

            const etaContent = document.getElementById('eta-content');

            // Modes to display (excluding walking)
            const modes = [
                { key: 'driving', name: 'üöó Driving', icon: 'üöó' },
                { key: 'transit', name: 'üöá Transit', icon: 'üöá' },
                { key: 'bicycling', name: 'üö¥ Cycling', icon: 'üö¥' }
            ];

            // Build table HTML
            let html = `
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr style="border-bottom: 2px solid #ddd;">
                            <th style="text-align: left; padding: 8px; font-weight: bold;">Mode</th>
                            <th style="text-align: center; padding: 8px; font-weight: bold;">From A</th>
                            <th style="text-align: center; padding: 8px; font-weight: bold;">From B</th>
                            <th style="text-align: center; padding: 8px; font-weight: bold;">To Dest</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            modes.forEach(mode => {
                const eta1 = etas1[mode.key];
                const eta2 = etas2[mode.key];

                const time1 = eta1 && !eta1.error ? eta1.duration : 'N/A';
                const time2 = eta2 && !eta2.error ? eta2.duration : 'N/A';

                html += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px; font-weight: 500;">${mode.name} ${mode.name.replace(/üöó|üöá|üö¥/, '')}</td>
                        <td style="text-align: center; padding: 10px; color: #1a73e8; font-weight: 600;">${time1}</td>
                        <td style="text-align: center; padding: 10px; color: #1a73e8; font-weight: 600;">${time2}</td>
                        <td style="text-align: center; padding: 10px; color: #28a745; font-weight: 600;">${time1}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            etaContent.innerHTML = html;
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            // Haversine formula to calculate distance in km
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function submitGuess() {
            if (!guessMarker || !actualDestination) {
                alert('Please place a guess marker on the map first!');
                return;
            }

            // Disable game mode
            gameActive = false;
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('randomBtn').style.display = 'none';

            // Get guess coordinates
            const guessPos = guessMarker.getPosition();
            const guessLat = guessPos.lat();
            const guessLng = guessPos.lng();

            // Calculate distance and score
            const distanceKm = calculateDistance(
                guessLat, guessLng,
                actualDestination.lat, actualDestination.lng
            );
            const distanceMiles = distanceKm * 0.621371;
            const score = calculateScore(distanceKm);

            // Show score animation
            showScoreAnimation(score);

            // Place actual destination marker
            const destLocation = {
                lat: actualDestination.lat,
                lng: actualDestination.lng
            };

            destinationMarker = new google.maps.Marker({
                position: destLocation,
                map: map,
                title: 'Actual Destination',
                label: 'D',
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: '#FF0000',
                    fillOpacity: 1,
                    strokeColor: '#FFFFFF',
                    strokeWeight: 2,
                    labelOrigin: new google.maps.Point(0, 0)
                },
                animation: google.maps.Animation.DROP
            });

            // Update guess marker style
            guessMarker.setLabel('G');

            // Draw line between guess and actual
            distanceLine = new google.maps.Polyline({
                path: [guessPos, destLocation],
                geodesic: true,
                strokeColor: '#FF0000',
                strokeOpacity: 0.7,
                strokeWeight: 2,
                map: map
            });

            // Fit map to show all markers
            const bounds = new google.maps.LatLngBounds();
            bounds.extend(actualOrigin1);
            bounds.extend(actualOrigin2);
            bounds.extend(guessPos);
            bounds.extend(destLocation);
            map.fitBounds(bounds);

            // Update origin and destination text
            document.getElementById('origin').innerHTML = `<strong>A:</strong> ${actualOrigin1.address}<br><strong>B:</strong> ${actualOrigin2.address}`;
            document.getElementById('destination').textContent = actualDestination.address;

            // Update ETA table to show actual destination times
            displayETAsTableWithDestination(actualDestination.etas1, actualDestination.etas2);

            // Show results
            const resultDiv = document.getElementById('result');
            const resultContent = document.getElementById('result-content');

            resultContent.innerHTML = `
                <div class="result-row"><span class="result-label">Your Score:</span> ${score} / 5000</div>
                <div class="result-row"><span class="result-label">Distance Off:</span> ${distanceKm.toFixed(2)} km (${distanceMiles.toFixed(2)} miles)</div>
                <div class="result-row"><span class="result-label">Actual Destination:</span> ${actualDestination.address}</div>
                <div class="result-row" style="margin-top: 10px;">
                    <span style="color: #1a73e8;">üìç A</span> = Origin 1 &nbsp;&nbsp;
                    <span style="color: #1a73e8;">üìç B</span> = Origin 2 &nbsp;&nbsp;
                    <span style="color: #FFA500;">‚¨§ G</span> = Your Guess &nbsp;&nbsp;
                    <span style="color: #FF0000;">‚¨§ D</span> = Actual Destination
                </div>
            `;
            resultDiv.style.display = 'block';

            // Show new game button
            document.getElementById('newGameBtn').style.display = 'block';

            // Update instructions
            document.getElementById('instructions').innerHTML = 'Click "New Game" to play again!';
            document.getElementById('instructions').style.background = '#d4edda';
            document.getElementById('instructions').style.color = '#155724';
        }

        // Initialize map when page loads
        window.initMap = initMap;
    </script>

    <!-- Load Google Maps API dynamically using server-side env-backed endpoint -->
    <script>
        (async function() {
            try {
                // Backend URL that serves the API key (same Heroku app as the game API)
                const mapsKeyEndpoint = 'https://toronto-etaguessr-api-cdf6cdc7db27.herokuapp.com/maps-api-key';

                const response = await fetch(mapsKeyEndpoint);
                if (!response.ok) {
                    throw new Error('Failed to fetch Maps API key');
                }

                const data = await response.json();
                const apiKey = data.googleMapsApiKey;

                if (!apiKey) {
                    throw new Error('Maps API key is missing from backend response');
                }

                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap`;
                script.async = true;
                script.defer = true;
                document.head.appendChild(script);
            } catch (err) {
                console.error('Failed to load Google Maps API:', err);
                const mapEl = document.getElementById('map');
                if (mapEl) {
                    mapEl.textContent = 'Failed to load map. Please check the server-side GOOGLE_MAPS_API_KEY configuration.';
                }
            }
        })();
    </script>
</body>
</html>
